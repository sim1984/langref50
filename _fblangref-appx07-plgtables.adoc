:sectnums!:
:ditto: &#12291;

[appendix]
[[fblangref-appx-plgtables]]
= Таблицы плагинов

Таблицы плагинов — это таблицы или представления, созданные для или с помощью различных плагинов для движка Firebird. Стандартные таблицы плагинов имеют префикс `PLG$` (но могут иметь и другие).

Таблицы плагинов не всегда существуют. Например, некоторые таблицы существуют только в базе данных безопасности, а другие таблицы будут созданы только при первом использовании плагина.

В этом приложении описаны только таблицы плагинов, созданные плагинами, включенными в стандартную поставку Firebird 5.0.

Таблицы плагинов не считаются системными таблицами.

== Плагин профилирования `Default_Profiler`

Таблицы профилировщика, перечисленные в этом приложении (имеющие префикс PLG$PROF_), создаются плагином Default_Profiler. Если создан собственный плагин профилировщика, он может использовать другие имена таблиц.

Таблицы моментальных снимков, а также представления и последовательности, автоматически создаются при первом использовании профилировщика. Они принадлежат текущему пользователю с разрешениями на чтение/запись для `PUBLIC`.

Когда сеанс удаляется, связанные данные в других таблицах моментальных снимков профилировщика также автоматически удаляются с помощью внешних ключей с опцией `DELETE CASCADE`.

Ниже приведен список таблиц, в которых хранятся данные профиля.

`PLG$PROF_SESSIONS`:: информация о сессиях профилирования.
`PLG$PROF_STATEMENTS`:: информация об SQL операторах.
`PLG$PROF_CURSORS`:: информация о курсорах.
`PLG$PROF_RECORD_SOURCES`:: информация об источниках записей.
`PLG$PROF_REQUESTS`:: информация об SQL запросах.
`PLG$PROF_PSQL_STATS`:: PSQL статистика.
`PLG$PROF_RECORD_SOURCE_STATS`:: статистика источников записей.

Кроме того, плагин `Default_Profiler` создаёт несколько представлений. Эти представления помогают извлекать данные профилирования, агрегированные на уровне операторов.

Они должны быть предпочтительным способом анализа собранных данных. Их также можно использовать вместе с таблицами для получения дополнительных данных, отсутствующих в представлениях.

После того, как «горячие точки» найдены, можно детализировать данные на уровне запроса через таблицы.

Ниже приведен список представлений, созданных профилировщиком:

`PLG$PROF_STATEMENT_STATS_VIEW`:: агрегированная статистика SQL операторов.
`PLG$PROF_PSQL_STATS_VIEW`:: агрегированная PSQL статистика.
`PLG$PROF_RECORD_SOURCE_STATS_VIEW`:: агрегированная статистика по источникам записей.


=== Таблица `PLG$PROF_SESSIONS`

Таблица `PLG$PROF_SESSIONS` содержит информацию о сессиях профилирования.

.Описание столбцов таблицы `PLG$PROF_SESSIONS`
[cols="<4m,<3m,<5", frame="all", options="header",stripes="none"]
|===
^| Наименование столбца
^| Тип данных
^| Описание

|PROFILE_ID
|BIGINT
|идентификатор сессии профилирования

|ATTACHMENT_ID
|BIGINT
|идентификатор соединения для которого производится профилирование

|USER_NAME
|CHAR(63)
|имя пользователя

|DESCRIPTION
|VARCHAR(255)
|описание переданное в параметре `RDB$PROFILER.START_SESSION`

|START_TIMESTAMP
|TIMESTAMP WITH TIME ZONE
|момент начала сессии профилирования

|FINISH_TIMESTAMP
|TIMESTAMP WITH TIME ZONE
|момент окончания сессии профилирования (NULL если сессия не завершена)
|===

Первичный ключ: `PROFILE_ID`

=== Таблица `PLG$PROF_STATEMENTS`

Таблица `PLG$PROF_STATEMENTS` содержит информацию об SQL операторах.

.Описание столбцов таблицы `PLG$PROF_STATEMENTS`
[cols="<4m,<3m,<5", frame="all", options="header",stripes="none"]
|===
^| Наименование столбца
^| Тип данных
^| Описание

|PROFILE_ID
|BIGINT
|идентификатор сессии профилирования

|STATEMENT_ID
|BIGINT
|идентификатор оператора

|PARENT_STATEMENT_ID
|BIGINT
|родительский идентификатор запроса - относится к подпрограммам.

|STATEMENT_TYPE
|VARCHAR(20)
|типа оператора BLOCK, FUNCTION, PROCEDURE или TRIGGER

|PACKAGE_NAME
|CHAR(63)
|Имя пакета

|ROUTINE_NAME
|CHAR(63)
|Имя функции, процедуры или триггера

|SQL_TEXT
|BLOB SUB_TYPE TEXT
|SQL текст для типа BLOCK
|===

Первичный ключ: `PROFILE_ID, STATEMENT_ID`

## Table `PLG$PROF_CURSORS`

Таблица `PLG$PROF_CURSORS` содержит информацию о курсорах.

.Описание столбцов таблицы `PLG$PROF_CURSORS`
[cols="<4m,<3m,<5", frame="all", options="header",stripes="none"]
|===
^| Наименование столбца
^| Тип данных
^| Описание

|PROFILE_ID
|BIGINT
|идентификатор сессии профилирования

|STATEMENT_ID
|BIGINT
|идентификатор оператора

|CURSOR_ID
|BIGINT
|идентификатор курсора

|NAME
|CHAR(63)
|имя явно объявленного курсора

|LINE_NUM
|INTEGER
|номер строки в которой определён курсор

|COLUMN_NUM
|INTEGER
|номер столбца в котором определён курсор
|===

 Первичный ключ `PROFILE_ID, STATEMENT_ID, CURSOR_ID`

=== Таблица `PLG$PROF_RECORD_SOURCES`

Таблица `PLG$PROF_RECORD_SOURCES` содержит информацию о методах доступа.

.Описание столбцов таблицы `PLG$PROF_RECORD_SOURCES`
[cols="<4m,<3m,<5", frame="all", options="header",stripes="none"]
|===
^| Наименование столбца
^| Тип данных
^| Описание

|PROFILE_ID
|BIGINT
|идентификатор сессии профилирования

|STATEMENT_ID
|BIGINT
|идентификатор оператора

|CURSOR_ID
|BIGINT
|идентификатор курсора

|RECORD_SOURCE_ID
|BIGINT
|идентификатор источника записи

|PARENT_RECORD_SOURCE_ID
|BIGINT
|идентификатор источника родительской записи

|LEVEL
|INTEGER
|уровень метода доступа. Необходим для расчёта отступов при конструировании плана.

|ACCESS_PATH
|BLOB SUB_TYPE TEXT
|описание метода доступа
|===

Первичный ключ: `PROFILE_ID, STATEMENT_ID, CURSOR_ID, RECORD_SOURCE_ID`

=== Таблица `PLG$PROF_REQUESTS`

Таблица `PLG$PROF_REQUESTS` содержит статистику выполнения SQL запросов.

Если профилировщик запущен с опцией `DETAILED_REQUESTS`, то таблица `PLG$PROF_REQUESTS` будет хранить подробные данные запросов, то есть одну запись для каждого вызова оператора. Это может привести к созданию большого количества записей, что приведет к медленной работе `RDB$PROFILER.FLUSH`.

Когда `DETAILED_REQUESTS` не используется (по умолчанию), таблица `PLG$PROF_REQUESTS` сохраняет агрегированную запись для каждого оператора, используя `REQUEST_ID = 0`.

.Описание столбцов таблицы `PLG$PROF_REQUESTS`
[cols="<4m,<3m,<5", frame="all", options="header",stripes="none"]
|===
^| Наименование столбца
^| Тип данных
^| Описание

|PROFILE_ID
|BIGINT
|идентификатор сессии профилирования

|REQUEST_ID
|BIGINT
|идентификатор запроса

|STATEMENT_ID
|BIGINT
|идентификатор SQL оператора

|CALLER_REQUEST_ID
|BIGINT
|идентификатор вызывающего запроса

|START_TIMESTAMP
|TIMESTAMP WITH TIME ZONE
|момент, когда данный запрос впервые собрал данные профилирования

|FINISH_TIMESTAMP
|TIMESTAMP WITH TIME ZONE
|момент завершения запроса

|TOTAL_ELAPSED_TIME
|BIGINT
|Накопленное время выполнения запроса (в наносекундах)
|===

Первичный ключ: `PROFILE_ID, REQUEST_ID`.

=== Таблица `PLG$PROF_PSQL_STATS`

Таблица `PLG$PROF_PSQL_STATS` содержит PSQL статистику.

.Описание столбцов таблицы `PLG$PROF_PSQL_STATS`
[cols="<4m,<3m,<5", frame="all", options="header",stripes="none"]
|===
^| Наименование столбца
^| Тип данных
^| Описание

|PROFILE_ID
|BIGINT
|идентификатор сессии профилирования

|REQUEST_ID
|BIGINT
|идентификатор запроса

|LINE_NUM
|INTEGER
|номер строки оператора

|COLUMN_NUM
|INTEGER
|номер столбца оператора

|STATEMENT_ID
|BIGINT
|идентификатор оператора

|COUNTER
|BIGINT
|количество выполнений для номера строки/столбца

|MIN_ELAPSED_TIME
|BIGINT
|Минимальное время выполнения (в наносекундах) для строки/столбца

|MAX_ELAPSED_TIME
|BIGINT
|Максимальное время выполнения (в наносекундах) для строки/столбца

|TOTAL_ELAPSED_TIME
|BIGINT
|Накопленное время выполнения (в наносекундах) для строки/столбца
|===

Первичный ключ: `PROFILE_ID, REQUEST_ID, LINE_NUM, COLUMN_NUM`.

=== Таблица `PLG$PROF_RECORD_SOURCE_STATS`

Таблица `PLG$PROF_RECORD_SOURCES` содержит статистику по методам доступа.

.Описание столбцов таблицы `PLG$PROF_RECORD_SOURCE_STATS`
[cols="<4m,<3m,<5", frame="all", options="header",stripes="none"]
|===
^| Наименование столбца
^| Тип данных
^| Описание

|PROFILE_ID
|BIGINT
|идентификатор сессии профилирования

|REQUEST_ID
|BIGINT
|идентификатор запроса

|CURSOR_ID
|BIGINT
|идентификатор курсора

|RECORD_SOURCE_ID
|BIGINT
|идентификатор источника записи

|STATEMENT_ID
|BIGINT
|идентификатор оператора

|OPEN_COUNTER
|BIGINT
|количество открытий источника записи

|OPEN_MIN_ELAPSED_TIME
|BIGINT
|Минимальное время открытия источника записи (в наносекундах)

|OPEN_MAX_ELAPSED_TIME
|BIGINT
|Максимальное время открытия источника записи (в наносекундах)

|OPEN_TOTAL_ELAPSED_TIME
|BIGINT
|Накопленное время открытия источника записи (в наносекундах)

|FETCH_COUNTER
|BIGINT
|Количество извлечений из источника записи

|FETCH_MIN_ELAPSED_TIME
|BIGINT
|Минимальное время извлечения записи из источника записи (в наносекундах)

|FETCH_MAX_ELAPSED_TIME
|BIGINT
|Максимальное время извлечения записи из источника записи (в наносекундах)

|FETCH_TOTAL_ELAPSED_TIME
|BIGINT
|Накопленное время извлечения записей из источника записи (в наносекундах)
|===

Первичный ключ: `PROFILE_ID, REQUEST_ID, CURSOR_ID, RECORD_SOURCE_ID`

=== Представление `PLG$PROF_STATEMENT_STATS_VIEW`

Представление `PLG$PROF_STATEMENT_STATS_VIEW` содержит агрегированную статистику SQL операторов.

.Описание столбцов представления `PLG$PROF_STATEMENT_STATS_VIEW`
[cols="<4m,<3m,<5", frame="all", options="header",stripes="none"]
|===
^| Наименование столбца
^| Тип данных
^| Описание

|PROFILE_ID
|BIGINT
|идентификатор сессии профилирования

|STATEMENT_ID
|BIGINT
|идентификатор оператора

|STATEMENT_TYPE
|VARCHAR(20)
|типа оператора BLOCK, FUNCTION, PROCEDURE или TRIGGER

|PACKAGE_NAME
|CHAR(63)
|Имя пакета

|ROUTINE_NAME
|CHAR(63)
|Имя функции, процедуры или триггера

|PARENT_STATEMENT_ID
|BIGINT
|идентификатор родительского оператора

|PARENT_STATEMENT_TYPE
|VARCHAR(20)
|типа родительского оператора BLOCK, FUNCTION, PROCEDURE или TRIGGER

|PARENT_ROUTINE_NAME
|CHAR(63)
|Имя родительской функции, процедуры или триггера

|SQL_TEXT
|BLOB SUB_TYPE TEXT
|SQL текст для типа BLOCK

|COUNTER
|BIGINT
|количество выполнений для номера строки/столбца

|MIN_ELAPSED_TIME
|BIGINT
|Минимальное время выполнения (в наносекундах) для строки/столбца

|MAX_ELAPSED_TIME
|BIGINT
|Максимальное время выполнения (в наносекундах) для строки/столбца

|TOTAL_ELAPSED_TIME
|BIGINT
|Накопленное время выполнения (в наносекундах) для строки/столбца

|AVG_ELAPSED_TIME
|BIGINT
|Среднее время выполнения (в наносекундах) для строки/столбца
|===

=== Представление `PLG$PROF_PSQL_STATS_VIEW`

Представление `PLG$PROF_PSQL_STATS_VIEW` содержит агрегированную PSQL статистику.

.Описание столбцов представления `PLG$PROF_PSQL_STATS_VIEW`
[cols="<4m,<3m,<5", frame="all", options="header",stripes="none"]
|===
^| Наименование столбца
^| Тип данных
^| Описание

|PROFILE_ID
|BIGINT
|идентификатор сессии профилирования

|STATEMENT_ID
|BIGINT
|идентификатор оператора

|STATEMENT_TYPE
|VARCHAR(20)
|типа оператора BLOCK, FUNCTION, PROCEDURE или TRIGGER

|PACKAGE_NAME
|CHAR(63)
|Имя пакета

|ROUTINE_NAME
|CHAR(63)
|Имя функции, процедуры или триггера

|PARENT_STATEMENT_ID
|BIGINT
|идентификатор родительского оператора

|PARENT_STATEMENT_TYPE
|VARCHAR(20)
|типа родительского оператора BLOCK, FUNCTION, PROCEDURE или TRIGGER

|PARENT_ROUTINE_NAME
|CHAR(63)
|Имя родительской функции, процедуры или триггера

|SQL_TEXT
|BLOB SUB_TYPE TEXT
|SQL текст для типа BLOCK

|LINE_NUM
|INTEGER
|номер строки оператора

|COLUMN_NUM
|INTEGER
|номер столбца оператора

|COUNTER
|BIGINT
|количество выполнений для номера строки/столбца

|MIN_ELAPSED_TIME
|BIGINT
|Минимальное время выполнения (в наносекундах) для строки/столбца

|MAX_ELAPSED_TIME
|BIGINT
|Максимальное время выполнения (в наносекундах) для строки/столбца

|TOTAL_ELAPSED_TIME
|BIGINT
|Накопленное время выполнения (в наносекундах) для строки/столбца

|AVG_ELAPSED_TIME
|BIGINT
|Среднее время выполнения (в наносекундах) для строки/столбца
|===

=== Представление `PLG$PROF_RECORD_SOURCE_STATS_VIEW`

Представление `PLG$PROF_RECORD_SOURCE_STATS_VIEW` содержит агрегированную статистику по методам доступа.

.Описание столбцов представления `PLG$PROF_RECORD_SOURCE_STATS_VIEW`
[cols="<4m,<3m,<5", frame="all", options="header",stripes="none"]
|===
^| Наименование столбца
^| Тип данных
^| Описание

|PROFILE_ID
|BIGINT
|идентификатор сессии профилирования

|STATEMENT_ID
|BIGINT
|идентификатор оператора

|STATEMENT_TYPE
|VARCHAR(20)
|типа оператора BLOCK, FUNCTION, PROCEDURE или TRIGGER

|PACKAGE_NAME
|CHAR(63)
|Имя пакета

|ROUTINE_NAME
|CHAR(63)
|Имя функции, процедуры или триггера

|PARENT_STATEMENT_ID
|BIGINT
|идентификатор родительского оператора

|PARENT_STATEMENT_TYPE
|VARCHAR(20)
|типа родительского оператора BLOCK, FUNCTION, PROCEDURE или TRIGGER

|PARENT_ROUTINE_NAME
|CHAR(63)
|Имя родительской функции, процедуры или триггера

|SQL_TEXT
|BLOB SUB_TYPE TEXT
|SQL текст для типа BLOCK

|CURSOR_ID
|BIGINT
|идентификатор курсора

|NAME
|CHAR(63)
|имя явно объявленного курсора

|CURSOR_LINE_NUM
|INTEGER
|номер строки в которой определён курсор

|CURSOR_COLUMN_NUM
|INTEGER
|номер столбца в котором определён курсор

|RECORD_SOURCE_ID
|BIGINT
|идентификатор источника записей

|PARENT_RECORD_SOURCE_ID
|BIGINT
|идентификатор родительского источника записей

|LEVEL
|INTEGER
|уровень метода доступа. Необходим для расчёта отступов при конструировании плана.

|ACCESS_PATH
|BLOB SUB_TYPE TEXT
|описание метода доступа

|OPEN_COUNTER
|BIGINT
|количество открытий источника записи

|OPEN_MIN_ELAPSED_TIME
|BIGINT
|Минимальное время открытия источника записи (в наносекундах)

|OPEN_MAX_ELAPSED_TIME
|BIGINT
|Максимальное время открытия источника записи (в наносекундах)

|OPEN_TOTAL_ELAPSED_TIME
|BIGINT
|Накопленное время открытия источника записи (в наносекундах)

|OPEN_AVG_ELAPSED_TIME
|BIGINT
|Среднее время открытия источника записи (в наносекундах)

|FETCH_COUNTER
|BIGINT
|Количество извлечений из источника записи

|FETCH_MIN_ELAPSED_TIME
|BIGINT
|Минимальное время извлечения записи из источника записи (в наносекундах)

|FETCH_MAX_ELAPSED_TIME
|BIGINT
|Максимальное время извлечения записи из источника записи (в наносекундах)

|FETCH_TOTAL_ELAPSED_TIME
|BIGINT
|Накопленное время извлечения записей из источника записи (в наносекундах)

|FETCH_AVG_ELAPSED_TIME
|BIGINT
|Среднее время извлечения записей из источника записи (в наносекундах)
|===

== Плагин управления пользователями `Srp`

=== Таблица `PLG$SRP`

Таблица `PLG$SRP` хранит список пользователей и информацию для их аутентификации плагинами аутентификации семейства SRP.

.Описание столбцов таблицы `PLG$SRP`
[cols="<4m,<3m,<5", frame="all", options="header",stripes="none"]
|===
^| Наименование столбца
^| Тип данных
^| Описание

|PLG$USER_NAME
|VARCHAR(63)
|Имя пользователя

|PLG$VERIFIER
|VARBINARY(128)
|Srp verifier

|PLG$SALT
|VARBINARY(32)
|Соль

|PLG$COMMENT
|BLOB SUB_TYPE TEXT
|Текстовый комментарий

|PLG$FIRST
|VARCHAR(32)
|Первое имя (имя)

|PLG$MIDDLE
|VARCHAR(32)
|Среднее имя (отчество)

|PLG$LAST
|VARCHAR(32)
|Последнее имя (фамилия)

|PLG$ATTRIBUTES
|BLOB SUB_TYPE TEXT
|Пользовательские аттрибуты (теги)

|PLG$ACTIVE
|BOOLEAN
|Флаг - активен ли пользователь

|===

=== Представление `PLG$SRP_VIEW`

Представление `PLG$SRP_VIEW` определяет какие пользователи доступны для просмотра через виртуальную таблицу `SEC$USERS` и
изменения с помощью оператор `ALTER USER ...`.

.Описание столбцов представления `PLG$SRP_VIEW`
[cols="<4m,<3m,<5", frame="all", options="header",stripes="none"]
|===
^| Наименование столбца
^| Тип данных
^| Описание

|PLG$USER_NAME
|VARCHAR(63)
|Имя пользователя

|PLG$VERIFIER
|VARBINARY(128)
|Srp verifier

|PLG$SALT
|VARBINARY(32)
|Соль

|PLG$COMMENT
|BLOB SUB_TYPE TEXT
|Текстовый комментарий

|PLG$FIRST
|VARCHAR(32)
|Первое имя (имя)

|PLG$MIDDLE
|VARCHAR(32)
|Среднее имя (отчество)

|PLG$LAST
|VARCHAR(32)
|Последнее имя (фамилия)

|PLG$ATTRIBUTES
|BLOB SUB_TYPE TEXT
|Пользовательские аттрибуты (теги)

|PLG$ACTIVE
|BOOLEAN
|Флаг - активен ли пользователь

|===

Данное представление хранит следующий SQL запрос

[source,sql]
----
SELECT 
  PLG$USER_NAME, 
  PLG$VERIFIER, 
  PLG$SALT, 
  PLG$COMMENT, 
  PLG$FIRST, 
  PLG$MIDDLE, 
  PLG$LAST, 
  PLG$ATTRIBUTES, 
  PLG$ACTIVE 
FROM PLG$SRP 
WHERE RDB$SYSTEM_PRIVILEGE(USER_MANAGEMENT) OR CURRENT_USER = PLG$SRP.PLG$USER_NAME
----

== Плагин управления пользователями `Legacy_UserManager`

=== Таблица `PLG$USERS`

Таблица `PLG$USERS` хранит список пользователей и информацию для их аутентификации плагином аутентификации `Legacy_Auth`.

.Описание столбцов таблицы `PLG$USERS`
[cols="<4m,<3m,<5", frame="all", options="header",stripes="none"]
|===
^| Наименование столбца
^| Тип данных
^| Описание

|PLG$USER_NAME
|VARCHAR(63)
|Имя пользователя

|PLG$GROUP_NAME
|VARCHAR(63)
|Имя группы

|PLG$GROUP_NAME
|VARCHAR(63)
|Имя группы

|PLG$UID
|INTEGER
|Идентификатор пользователя в POSIX

|PLG$GID
|INTEGER
|Идентификатор группы в POSIX

|PLG$PASSWD
|VARBINARY(64)
|Хеш пароля

|PLG$COMMENT
|BLOB SUB_TYPE TEXT
|Текстовый комментарий

|PLG$FIRST_NAME
|VARCHAR(32)
|Первое имя (имя)

|PLG$MIDDLE_NAME
|VARCHAR(32)
|Среднее имя (отчество)

|PLG$LAST_NAME
|VARCHAR(32)
|Последнее имя (фамилия)

|===

=== Представление `PLG$VIEW_USERS`

Представление `PLG$VIEW_USERS` определяет какие пользователи доступны для просмотра через виртуальную таблицу `SEC$USERS` и
изменения с помощью оператор `ALTER USER ...`.

.Описание столбцов представления `PLG$VIEW_USERS`
[cols="<4m,<3m,<5", frame="all", options="header",stripes="none"]
|===
^| Наименование столбца
^| Тип данных
^| Описание

|PLG$USER_NAME
|VARCHAR(63)
|Имя пользователя

|PLG$GROUP_NAME
|VARCHAR(63)
|Имя группы

|PLG$GROUP_NAME
|VARCHAR(63)
|Имя группы

|PLG$UID
|INTEGER
|Идентификатор пользователя в POSIX

|PLG$GID
|INTEGER
|Идентификатор группы в POSIX

|PLG$PASSWD
|VARBINARY(64)
|Хеш пароля

|PLG$COMMENT
|BLOB SUB_TYPE TEXT
|Текстовый комментарий

|PLG$FIRST_NAME
|VARCHAR(32)
|Первое имя (имя)

|PLG$MIDDLE_NAME
|VARCHAR(32)
|Среднее имя (отчество)

|PLG$LAST_NAME
|VARCHAR(32)
|Последнее имя (фамилия)

|===

Данное представление хранит следующий SQL запрос

[source,sql]
----
SELECT 
  PLG$USER_NAME, 
  PLG$GROUP_NAME, 
  PLG$UID, 
  PLG$GID, 
  PLG$PASSWD,
  PLG$COMMENT, 
  PLG$FIRST_NAME, 
  PLG$MIDDLE_NAME, 
  PLG$LAST_NAME
FROM PLG$USERS
WHERE CURRENT_USER = 'SYSDBA'
   OR CURRENT_ROLE = 'RDB$ADMIN'
   OR CURRENT_USER = PLG$USERS.PLG$USER_NAME
----
